# 第 6 章 更广阔的景观

正如我们之前提到的，有一系列非常广泛的主题和技术属于异常检测。 在本章中，我们将讨论一些可能有用的流行工具。 请记住，对于所有情况来说，没有任何东西可以完美地开箱即用。 将本章中的主题视为您自己进行进一步研究的提示。

在考虑本章中的方法时，我们建议您尝试询问“这会产生什么样的假设？”和“我如何评估结果的意义和可信度？”

## 6.1 形状目录

在Dunning和Friedman的“异常检测新视角”一书中，作者写了一篇使用形状目录的技术。 该技术的要点如下。 首先，您必须从一个示例数据集开始，该数据集表示没有任何异常的度量标准的时间序列。 您可以将此数据集拆分为较小的窗口，使用窗口函数来屏蔽除特定区域之外的所有区域，并对生成的形状进行编目。 假设是可以通过重新排列此形状目录中的元素来重建对此时间序列的任何非异常观察。 任何在合理范围内不匹配的东西都被认为是异常现象。

这很不错，但根据我们的经验，大多数机器数据的表现并不像EKG图表。 至少，不是在很小的时间尺度上。大多数机器数据在第二到第二的基础上比这更嘈杂。

## 6.2 均值漂移分析

在本书的大部分内容中，我们讨论了异常检测方法，这些方法试图检测度量标准中的大的突然尖峰或骤降。 异常具有许多形状和大小，并且它们绝对不限于这些短期像差。 一些异常表现为缓慢但显着的偏离一些平常的平均值。 这些被称为平均移位，它们代表模型参数的基本变化。由此我们可以推断出系统的状态发生了巨大变化。

一种流行的技术称为CUSUM，它代表累积和控制图。 CUSUM技术是对熟悉的控制图的修改，该控制图侧重于度量的小的，逐渐的变化而不是平均值的大偏差。

CUSUM技术假设度量的各个值均匀分布在均值上。 一方面或另一方太多可能意味着平均值已经改变或移动了一些重要数量。

下图显示了具有均值偏移的数据库的吞吐量。

[图 6.1](图6-1。）

我们可以将EWMA控制图应用于此数据集，就像在工作示例中一样。 这是它的样子。

[图 6.2](图6-2。）

这个控制图肯定可以检测到平均偏移，因为度量标准位于较低控制线的下方，但这通常发生在具有大量尖峰的高度可变数据集中！ EWMA控制图非常适合检测峰值，但不是平均值。 我们来试试CUSUM吧。 在此图像中，为清晰起见，我们仅显示数据的第一部分：

[图 6.3](图6-3。）

好多了！ 您可以看到CUSUM图表检测到平均位移低于下限阈值。


## 6.3 聚类

并非所有异常检测都基于度量的时间序列。 聚类或聚类分析是将元素组合在一起以尝试找出奇数元素的一种方法。 Netflix撰写了基于聚类分析的异常检测方法。他们在服务器集群上应用聚类分析技术来识别异常，行为不当或表现不佳的服务器。

K-Means聚类是一种常见的算法，实现起来相当简单。 这是一个例子：

[图 6.4](图6-4。）

## 6.4 非参数分析

并非所有异常检测技术都需要模型来得出有关指标的有用结论。 有些人完全避开模特！ 这些被称为非参数异常检测方法，并使用来自更大领域的理论，称为非参数统计。

Kolmogorov-Smirnov检验是一种非参数方法，已在监测界得到普及。 它测试两个样本的分布变化。 它可以回答的问题类型的一个例子是，“本周CPU使用率的分布与上周显着不同吗？”当然，你的时间间隔不一定要长达一周。

我们曾尝试用非高斯分布值解决粘性问题时学到了一个有趣的教训。 我们想弄清楚我们看到特定价值的可能性有多大。 我们决定保留我们看到的所有值的直方图，并在我们看到它时计算每个值的百分位数。 如果一个值超过99.9％，我们推断，那么我们可以认为它是一个千分之一的事件。

不是这样！ 出于几个原因，主要是我们从样本中计算我们的百分位数，并试图推断出该值存在于人口中的概率。 你可以像我们一样，立即看到谬误，如果你只是假设观察到的价值比我们之前看到的高得多。 我们看到这个价值的可能性有多大？ 除了伤害脑力的存在主义问题之外，还有明显的暗示，我们需要知道人口的分布才能回答这个问题。

通常，通过比较各组值的分布（通常通过直方图）来工作的这些非参数方法不能在每个值到达时在线使用。 那是因为很难将单个值（当前观察值）与一组值的分布进行比较。

## 6.5 Grubbs’ Test和ESD

Grubbs’ Test用于测试一组数据是否包含异常值。 假设该集合遵循近似高斯分布。 这是测试的一般过程，假设您有一个合适的数据集D.

1.计算样本均值。 我们称之为μ。
2.计算样本标准偏差。 我们称之为s。
3.对于D中的每个元素i
4.计算abs（i  - μ）/ s。 这是偏离样本平均值i的标准偏差数。
5.现在你与D中每个元素的平均距离。取最大值。
6.现在你有任何单个元素远离平均值的最大距离（标准偏差）。 这是测试统计。
7.将其与临界值进行比较。 临界值（仅为阈值）是根据某个显着性水平计算出来的，即您想要的一些覆盖率。 换句话说，如果要将异常值的阈值设置为总体中值的95％，则可以使用公式计算该阈值。 在这种情况下，临界值最终以标准偏差为单位。 如果您在步骤5中计算的值大于阈值，那么您有统计上显着的证据表明您有异常值。

Grubbs’ Test可以告诉您数据集中是否有一个外部。 应该直截了当地确定哪个元素是异常值。

ESD测试是一种概括，可以测试您是否有异常值。 它可以回答这个问题，“数据集中包含多少个异常值？”原理是相同的 - 它正在查看各个元素的标准偏差。 这个过程比这更精细，因为如果你有两个异常值，它们会干扰样本均值和标准差，所以你必须在每次迭代后删除它们。

现在，这对时间序列有什么用？ 您需要开始使用近似高斯（正态）分布式数据集。 回想一下，大多数时间序列模型可以分解为单独的组件，通常只有一个随机变量。 如果您可以拟合模型并将其减去，那么您最终会得到该随机变量。 这正是Twitter的BreakoutDetection3 R软件包所做的。 他们的大多数工作都包含了一个非常困难的问题，即自动拟合一个可以从时间序列中减去的模型。 在那之后，它只是一个ESD测试。

这是我们认为属于“长期”异常检测类别的东西，因为它不是你可以在线观察新值的东西。

有关更多详细信息，请参阅“工程统计手册”中的“Grubbs'异常值测试”页面。

## 6.6 机器学习

机器学习是一种元技术，您可以在其他技术之上进行分层。 它主要涉及计算机在没有明确指示的情况下预测或查找数据结构的能力。 如今，“机器学习”或多或少已成为会话使用的热门术语，但它基于经过深入研究的理论和技术。 尽管一些技术已经存在了几十年，但由于总体数据量和计算能力的提高，它们近来已经获得了极大的普及，这使得一些算法更加可行。 机器学习本身分为两个不同的类别：无监督和监督。

有监督的机器学习涉及构建一组观察数据的训练集，其中标记的输出指示正确的答案。 这些答案用于训练模型或算法，然后训练的行为可以预测新数据集的未知输出。 术语监督是指使用训练数据的已知正确输出来优化模型，使得它可以获得最低的错误率。

与监督对手不同，无监督机器学习并不试图找出如何获得正确答案。 相反，无监督机器学习算法的主要目标是在数据集中找到模式。 聚类分析是无监督机器的主要组成部分，使用的一种方法是K均值聚类。

## 6.7 合奏与共识

从来没有一种适合异常检测的万能解决方案。 相反，有些人选择将多种技术组合成一个组或整体。 整体的每个元素对其看到的数据投票，表示是否检测到异常。 然后使用这些投票形成共识，或者是否检测到异常的总体决定。 这种方法背后的一般思想是，虽然单个模型或方法可能并不总是正确的，但结合多种方法可能会提供更好的平均结果。

## 6.8 用于控制误报的过滤器

异常检测方法和模型本身没有足够的上下文来知道系统是否实际上是异常的。 为此目的利用它们是你的任务。 另一方面，您还需要知道何时不依赖于您的异常检测框架。 当系统或过程非常不稳定时，模型很难正常工作。 我们强烈建议实施过滤器以减少误报的数量。 我们使用的一些过滤器包括：

- 当检测到异常时发送警报，而不是在一段时间内检测到N个异常时发送警报。
- 当系统看起来太不稳定而无法确定任何类型的正常行为时，可以抑制异常。 例如，方差 - 均值比（离散度指数）或另一个无维度度量可用于指示系统的行为是否稳定。
- 如果系统违反阈值并触发异常或发送警报，除非系统首先重置为正常，否则不要再发送另一个警报。 这可以通过具有重置阈值来实现，低于该重置阈值，感兴趣的度量必须在它们可以再次触发高于上阈值之前下降。

过滤器不必复杂。 有时，简单地忽略可能导致警报滋扰的指标会更简单，更有效。 Ruxit最近发表了一篇名为“参数化异常检测设置”的博客文章，其中描述了它们的异常检测设置。 虽然他们没有将其称为“过滤器”，但其中一个设置会禁用针对低流量应用和服务的异常检测，以避免不必要的警报。

## 6.9 工具

您通常不必自己实现整个异常检测框架。 作为监控的重要组成部分，异常检测一直是许多监控项目和公司关注的焦点，这些项目和公司已经实现了我们在本书中讨论过的许多内容。

### Graphite and RRDTool
Graphite和RRDTool是流行的时间序列存储和绘图库，已经存在多年。 两者都包括Holt-Winters预测，可用于检测传入时间序列指标中的异常观察。 一些监控平台，如Ganglia，它建立在RRDTool上，也具有此功能。 RRDTool本身内置了一个通用的异常检测算法，虽然我们并不知道有人使用它（不出所料）。

### Etsy’s Kale Stack

Etsy的Skyline项目是Kale堆栈的一部分，包括用于异常检测的各种算法。 例如，它具有以下实现，其中包括：

- 控制图
- 直方图
- Kolmogorov-Smirnov检验

它使用集成技术来检测异常。 重要的是要记住，并非所有算法都适用于每个数据集。

### R Packages

有许多R软件包可用于许多异常检测方法，如预测和机器学习。 不足之处是很多很简单。 它们通常只是不用于监视系统的参考实现，因此可能很难将它们实现到您自己的堆栈中。

另一方面，Twitter的异常检测R包实际上在他们的生产监控系统中运行。 他们的包使用时间序列分解技术来检测数据集中的点异常。

### Commercial and Cloud Tools

您可能对使用基于云的异常检测服务更感兴趣，而不是将异常检测方法和工具实施或合并到您自己的监控基础架构中。 例如，像Ruxit，VividCortex，AppDynamics和其他公司在应用程序性能管理（APM）领域的公司提供某种类型的异常检测服务，通常在“基线”或类似的东西的标题下。

使用云服务的好处在于它通常更容易使用和配置，并且提供商通常具有与通知和警报系统的丰富集成。 异常检测服务也可能提供比您自己构建的诊断工具更好的诊断工具，特别是如果它们可以提供上下文信息。 另一方面，基于云的服务的一个缺点是，因为很难构建适用于所有内容的解决方案，所以它可能无法像您自己构建的那样工作。




