# 第 4 章 处理趋势和季节性

趋势和季节性是时间序列指标的两个特征，打破了许多模型。 事实上，它们是静态阈值破坏的两个主要原因之一（另一个原因是系统彼此不同）。 趋势是指标值的持续增加或减少。 另一方面，季节性反映了系统中出现的周期性（周期性）模式，通常高于基线然后再次下降。 常见的季节性时段是每小时，每天和每周，但您的系统可能有一个更长的季节性时段，甚至是不同时期的某种组合。

考虑季节性和趋势影响的另一种方法是，考虑异常是局部还是全局是非常重要的。 例如，局部异常可能是闲置期间的尖峰。 它不会整体记录为异常高，因为它在繁忙时期仍远低于异常高的值。 相反，全局异常无论何时发生，都会异常高（或低）。 目标是能够检测两种异常。 显然，静态阈值只能在存在季节性或趋势时检测全局异常。 检测局部异常需要应对这些影响。

许多时间序列模型，如ARIMA系列模型，具有处理趋势的属性。 这些模型还可以适应季节性，略有扩展。

## 4.1 处理趋势

趋势打破模型，因为具有趋势的时间序列的值随着时间的推移不稳定或不稳定。 在趋势增加的时间序列上使用基本的固定控制图是一个坏主意，因为它保证最终超过控制上限。

趋势违反了许多简单的假设。 具有趋势的指标的平均值是多少？ 平均值没有单一值。 相反，均值实际上是一个以时间为参数的函数。

值分配怎么样？ 您可以使用直方图对其进行可视化，但这会产生误导。 由于趋势导致值随时间增加或减少，因此直方图将随着时间的推移变得越来越宽。

简单移动平均线或EWMA怎么样？ 移动平均值应随趋势本身而变化，事实确实如此。 不幸的是，这种方法效果不佳，因为移动平均线在趋势存在时滞后，并且将始终高于或低于典型值。

[图 4.1](图4-1。 具有线性趋势和具有不同衰减因子的两个指数加权移动平均线的时间序列，表明它们在具有趋势时滞后于数据。)

你如何应对趋势？ 首先，重要的是要了解具有趋势的指标可以被视为其他指标的组合。 其中一个组件是趋势，因此处理趋势的解决方案很简单：找到描述趋势的模型，并从度量值中减去趋势！ 趋势消除后，您可以使用我们之前提到的模型。

可以有许多不同类型的趋势，但线性非常常见。 这意味着时间序列以恒定速率增加或减少。 要删除线性趋势，您可以简单地使用第一个差异。 这意味着您要考虑时间序列的连续值之间的差异，而不是时间序列本身的原始值。 如果你还记得你的微积分，这与衍生物有关，而且在时间序列中，听到人们谈论衍生物（或增量）的第一个差异是很常见的。

## 4.2 处理季节性

季节性时间序列数据具有周期。 这些通常在观察时很明显，如图4-2所示。

[图 4.2](图4-2。 服务器的平均负载，显示一段时间内的重复循环。)

季节性与趋势非常相似。 事实上，如果你“缩放”季节性的时间序列，它看起来就像趋势。 这是因为季节性变化趋势。 季节性度量随着时间的变化而增加或减少，而不是以固定的速率增加或减少。 可以想象，像EWMA这样的问题与线性趋势有着相同的问题。 它们落后了，在某些情况下它可能会变得如此糟糕，以至于EWMA与季节性模式完全不同步。 这在图4-3中很容易看到。

[图 4.3](图4-3。 正弦波和正弦波的EWMA，显示EWMA的滞后如何导致它在大多数时间预测错误。)

应对季节性与趋势完全相同：您需要分解和减去。 然而，这一次，由于季节性成分的模型更为复杂，因此更难实现。 此外，度量标准中可能有多个季节性组件！ 例如，您可以拥有每日期和每周期的季节性趋势。

## 4.3 多指数平滑

引入多指数平滑以解决在具有趋势和/或季节性的度量上使用EWMA的问题。 它提供了另一种方法：它不是通过分解来修改度量以适合模型，而是更新模型以适应度量的本地行为。 Holt-Winters（也称为Holt-Winters三指数平滑方法）是最着名的实现，这是我们将要关注的内容。

多指数平滑模型通常最多包含三个组件：EWMA，趋势组件和季节性组件。 趋势和季节性成分也是EWMA。 例如，趋势分量只是连续点之间差异的EWMA。 这与我们在讨论处理趋势的方法时所讨论的方法相同，但这次我们将其用于模型而不是原始度量。 使用单个EWMA，有一个平滑因子：α（alpha）。 因为趋势和季节性还有两个EWMA，它们也有自己的平滑因子。 通常它们被表示为趋势的β（β）和季节性的γ（伽马）。

预测度量的当前值类似于我们之前讨论过的模型，但稍作修改。 您从相同的“next = current”公式开始，但现在您还必须添加趋势和季节性条款。 在存在趋势和季节性的情况下，多指数平滑通常比天真模型产生更好的结果。

多指数平滑在数学公式方面可能会有点复杂，但直观上并没有那么糟糕。 我们建议预测的“Holt-Winters季节性方法”第1部分：原则和实践进行详细推导。 但这肯定会让事情变得更难：

- 你必须事先知道季节性的时期。 该方法无法解决这个问题。 如果你没有做到这一点，你的模型将不准确，你的结果也不准确。
- 有三种EWMA平滑参数可供选择。 为参数选择正确的值成为一个微妙的过程。 参数的微小变化可以在预测值中产生大的变化。 许多实现使用优化技术来确定对给定样本数据最有效的参数。

考虑到这一点，您可以使用多指数平滑来构建SPC控制图，就像我们在前面章节中讨论的那样。 优点和缺点与我们以前见过的大致相同。

## 4.4 预测趋势和季节性的潜在问题

除了更复杂之外，在某些常见情况下，可以处理趋势和季节性的高级模型仍然存在问题。 例如，您可能会猜测，外围数据可能会导致未来的预测失败，这是真的，具体取决于您使用的参数：

- 中断可以使模型在下一个周期中再次预测中断，从而导致错误警报。
- 假期通常与季节性不同步。
- 可能有像迈克尔杰克逊去世的不寻常事件。 这实际上可能是您想要提醒的事情，但显然不是系统故障或故障。
- 存在令人讨厌的问题，例如夏令时变化，特别是跨时区和半球。

一般来说，预测模型的致命弱点与给予他们力量的东西相同：他们可以观察到可预测的行为并对其进行预测，但结果他们可能被愚弄以预测错误的事物。 这取决于您使用的参数。 过于敏感，你会得到误报; 太强大，你错过告警。

在很大的时间尺度上运行。 在您可能使用的大多数系统中，季节性是每小时，每天和/或每周。 如果你试图以更高的分辨率预测事物，比如秒，那么时间尺度之间就会有很多不匹配，因为它们不是很有用。 上周一的周一早上交通量的飙升可能预示着今天早上的飙升相当不错，但并没有下降到第二个水平。

## 4.5 傅立叶变换

有时很难确定指标的季节性。 对于多个海洋组成部分的指标尤其如此。 幸运的是，有一个完整的时间序列分析领域专注于这一主题：光谱分析，即频率及其相对强度的研究。 在这个领域内，有一个非常重要的函数称为傅立叶变换，它将任何信号（如时间序列）分解为不同的频率。 这利用了一个非常有趣的事实，即任何信号都可以分解成单独的正弦波。

傅立叶变换用于许多领域，例如声音处理，以分解，操纵和重新组合构成信号的频率。 你会经常听到人们提到FFT（快速傅里叶变换）。 完美主义者会指出它们可能意味着DFT（离散傅里叶变换）。


使用傅里叶变换，可以采用非常复杂的时间序列，可能包含许多季节性分量，将它们分解为单个频率峰值，然后从原始时间序列中减去它们，仅保留您想要的信号。 听起来不错，双关语！ 但是，大多数机器数据（与音频波不同）实际上并不是由强频率组成。 至少，除非你在数周或数月的长时间范围内观察它，否则它不会。 即便如此，只有一些指标往往会有这种行为。

傅立叶变换的一个例子是Netflix的Scryer，它用于根据分解的频率和其他方法预测（或预测）需求。 也就是说，我们还没有看到实际上在异常检测中使用的傅里叶变换。 Scryer预测，它不会检测到异常。

在我们看来，使用DFT可以完成的有用的事情，例如实现低通或高通滤波器，可以使用更简单的方法来完成。 可以使用移动平均值实现低通滤波器，并且可以使用差分来实现高通滤波器。

## 4.6 结论

趋势和季节性将猴子扳手投入到许多模型中，但通过将度量作为几个信号的总和来处理，通常可以很好地处理它们。 预测度量标准的行为就变成了将信号分解为组件部分，将模型拟合到组件以及从原始组件中减去可预测组件的问题。

一旦你完成了这个，你基本上已经摆脱了信号的非静止部分，理论上，你应该能够将标准技术应用于剩下的静止信号。