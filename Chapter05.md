# 第 5 章 用于监测的实用异常检测

回想一下，我们的本书目标之一是帮助您实际获得在生产中运行的异常检测并解决您当前系统的监控问题。

添加异常检测的典型目标可能包括：

- 避免为每台服务器设置或更改阈值，因为计算机彼此不同
- 避免在服务器，功能和工作负载随时间变化时修改阈值
- 避免在一天或一周的某些时间发出错误警报的静态阈值，并在其他时间错过告警

一般来说，你可以将这些目标描述为“只是让Nagios对某些检查更好一点。”

另一个目标可能是在不生成警报的情况下查找所有异常的度量标准，以用于诊断问题。 我们认为这是一个非常难的问题，因为它非常普遍。 你可能在书中的这一点上理解了为什么。 虽然您可以根据具体情况轻松地将本章中的讨论应用于该方法，但我们不会在本章中关注此目标。

开始的最佳位置通常是您现在遇到最痛苦的监控问题。 查看您的警报历史记录或中断情况。 如果没有提醒通知您，最大噪音的来源或问题发生的地方是什么？

## 5.1 异常检测是正确的方法吗？

并非您发现的所有警报问题都可通过异常检测解决。 有些人来自警告错误的事情，期间。 例如，在很多环境中，磁盘空间不足是一种经典的噪音警报。 磁盘达到典型的95％阈值，然后每天多次回落到它下面，或者它们永远保持在98％，这没关系，或者它们在几分钟内从5％变为100％。 但这些问题并不是因为您将阈值设置为错误的值，或者您需要适应性自学习行为。 问题是你需要警告预计的空间耗尽时间，而不是警告完整性。 这不是异常现象。

监控噪音的另一个常见来源是不可操作的警报。 如果警报发出可能甚至不是真正问题的问题，或者没有解决方案或补救措施，并且并不意味着需要某人实际执行某些操作，则解决方案是删除警报。 或者至少重新考虑一下。 数据库中的复制延迟是我们经常看到的一个例子。 如果你没有得到一个好的答案，那么问你为什么他们应该在凌晨2点关心度量标准的值（“那么什么？”问题），你可能没有一个好的警报。

这意味着三件重要的事情：

- 您需要清楚明确地定义您要检测的问题。 如果有直接的方法来衡量它的发生，这也是最好的。
- 问题的最佳指标通常与一个或多个业务目标或预期结果直接相关。 换句话说，与实际影响相关的关键绩效指标（关键绩效指标）。
- 要检测更复杂的问题，您可能需要将系统行为与已知模型相关联，例如物理定律或排队理论等。 如果您没有描述系统行为方式的模型，您如何知道您对问题的定义是否正确？

如果你能接近这一点，你可能会很好地利用异常检测来解决你的警报问题。

## 5.2 选择度量标准

确保您尝试检测的问题具有可靠的信号非常重要。 使用异常检测来提醒那些在一次中断期间看起来很奇怪的指标并不是一个好主意。 我们自己这样做的一件事就是在正常的系统运行期间，指标是不断变化的。 您需要查找在健康系统行为期间始终正常的度量标准（或度量标准组合），并在系统出现问题时始终出现异常。 这里“正常”和“异常”与度量的本地行为相比，因为如果有可靠的全局好/坏，您可以使用阈值。

通常最好查看单个特定的API端点，网页或其他操作。 例如，您可以在所有API端点上检测全局异常 - 但这会导致两个问题。 首先，平均而言可能会丢失一个小问题。 其次，您将获得多模态分布和其他复杂信号。 最好分别检查每种不同的东西。 如果这太多了，那么只需选择一个开始，例如“添加到购物车”操作。

您可以检查的示例指标包括：

- 错误率
- 吞吐量
- 延迟（响应时间），虽然这很棘手，因为延迟几乎总是具有复杂的多模态分布
- 并发，服务需求，积压，队列长度，利用率以及容量负载或饱和度的类似指标; 除非您找到合适的模型，否则所有这些特征通常都具有难以使用标准统计工具进行分析的特征

## 5.3 甜蜜点

既然您已选择要检查异常的指标，则需要分析其行为，并查看是否可以使用工具箱中相对简单的工具来执行此操作。 如果你愿意，你可以自由地做一些更复杂的事情，但是我们在本章中的建议是为了以低成本获得有用的结果，而不是发明可获得专利的东西。

最简单的应用工具是按顺序加权移动控制图1和Holt-Winters预测“开箱即用”。如果你选择正确的指标或将它们应用于输出，你可以用这些方法完成很多工作。 一个简单的模型。

两者都依赖于高斯分布的残差，因此您需要首先检查它。 运行适当数量的度量标准历史记录，例如一周左右，通过所选工具创建新系列，然后从原始系列中减去此新系列以获取残差并检查结果的分布。

在某些情况下，您几乎肯定无法获得可用的结果。 例如，汇率在我们的经验中往往看起来是正常的。这导致了一个简单的转换：只需记录一致性，然后再试一次。

另一个简单的技术是查看度量的第一个差异（衍生物）。 从下一个减去每个观察，然后再试一次。 回想一下，这基本上断言度量的行为可以用以下公式预测：next = current + noise。 然而，这种技术的一个缺点是它改变了度量值的突然变化的形状。 考虑一个总是500的度量，然后一次观察下降到200，再次回到500。 这是一个急剧向下的尖峰。 如果您将此指标区分开来，则结果将是一个保持为0的指标，高峰时间降至-200，翻转至+200，然后再返回。 差异导致尖峰变成曲折，分析可能更复杂。

您还可以尝试更精细或更粗略的时间分辨率，例如五分钟间隔而不是秒或秒或分钟。 这是一种低通滤波器，可以消除噪声，但代价是丢弃可能有用的信息。

我们之前讨论了使用标准三西格玛数学检测到的异常情况。 因此，除非它们在一个区间内以给定频率发生，否则人们抑制异常是非常常见的。 比如，在30分钟的时间内，在一分钟的分辨率下有五个或更多的异常。

最后，您可以查看简单模型，例如多个指标之间的线性关系。 例如，如果数据库的查询吞吐量与服务器的CPU利用率密切相关，则可以尝试按吞吐量划分利用率并查找结果中的异常。 这是一种检查CPU利用率相对于服务器要求执行的工作是否异常的简单方法。

服务器及其指标与指纹不同。 其中一条建议可能适合您，而且对您的朋友完全失败。

所有这些技术都是试错法，用于检查是否存在可以描述度量标准的正常行为的某些上下文或可预测性。 我们试图将当前观察与周围的观察，季节性间隔的过去行为，其他指标或这些的组合联系起来。

如果您可以找到指标和方法或模型的可用组合，您可以在其上撒上三个西格玛并完成。 重复一下，关键是要确保：

- 度量可靠地表明重要的一个条件
- 模型产生高斯分布式残差，因此三西格玛方法实际上有效
- 超出限度的值通过“那又怎样？”测试，即异常是坏

## 5.4 一个工作的例子

在本节中，我们将通过一个实际示例演示我们到目前为止所介绍的一些技术。 我们将使用数据库的吞吐量（每秒查询数）作为我们的指标。

为了总结我们的思考过程，我们创建了以下流程图，您可以将其用作决策树。 这是一种极端的简化，有点偏向于我们自己的经历，但它应该足以让你开始并在异常检测技术的空间中定位自己。

[图 5.1](图5-1。)

我们将使用此决策树为该示例选择合适的异常检测技术。 在那个问题上，让我们来看看我们将要处理的数据。 下图显示了大约46小时的吞吐量。

[图 5.2](图5-2。)

首先，观察此度量标准在此服务器上有多奇怪。 在像这样的数据库服务器上，吞吐量是表示正在完成的工作的最佳度量。 您可以看到，很难描述此服务器上的正常吞吐量是什么样的，因为它的工作负载是动态的。 有时它什么都不做，有时它做了很多。 右边的巨型穗是异常的吗？ 大概。 这是“糟糕吗？”嗯......它正在做它被要求做的工作，不是吗？ 那是不是异常？

你不能只在这个数据集上询问“异常在哪里？”。 这不是一个很好的问题，甚至人类也无法判断。 我们需要更多背景来形成更好的问题。

我们可以通过异常检测回答关于此数据集的一个更具体的问题是“短时间内吞吐量何时显着降低？”这种对度量标准的简单行为可能有很多原因，例如资源争用或锁定。 我们可以通过查找指标中的局部异常来回答这个问题。 这更可行。

我们将放大数据集的一个更有趣的部分，显示我们有兴趣检测的异常类型。 这个较小的部分超过8小时的间隔。

[图 5.3](图5-3。)

在这个图中，你会注意到吞吐量随着近似线性的趋势而增加，在三分之二的标记附近略有下降。 在图的中间，您可以看到吞吐量大幅下降。 这些在短时间内发生的跌落是我们决定尝试检测的异常现象。

现在我们知道了异常检测问题的范围，让我们尝试使用决策树来确定哪种方法可能有用。 对于“检测时间”，我们知道我们对短时间尺度方法感兴趣，因此我们将遵循右侧的路径。 对于线性趋势，我们没有固定均值，因此我们将遵循“已知均值”的“否”路径。现在我们归结为“可变性”。该元素具有高度可变性和指数性 平滑往往会在这种情况下产生更好的结果。

如果我们的数据集没有趋势，我们可能最终得到一个固定的控制图方法，这比使用指数平滑更简单。 以前，我们提到过这种趋势可以通过第一个差异或衍生物来消除。 让我们尝试一下。

[图 5.4](图5-4。)

[图 5.5](图5-5。)

差分后，看起来我们已经消除了趋势。 大！ 现在我们有一个已知的固定均值为0，我们可以使用普通的控制图。 由于价差随着时间而变化并且不是我们先验知道的，我们将使用EWMA控制图，该图使用EWMA来主要根据最近的数据值绘制限值。

[图 5.6](图5-6。)

这是具有高斯分布曲线的残差直方图。

[图 5.7](图5-7。控制图中差异数据的残差直方图。)

我们在哪里发出异常信号？ 当度量标准有短暂的显着下降时，要判断它并不容易。 当吞吐量异常降低然后返回其原始值时，差异元素会出现曲折，这种情况很难检查。 因此，虽然差分处理线性趋势，但它使预测更加困难。

也许，我们应该尝试另一种选择：在原始指标上进行多指数平滑，而不是差分。 这应该很好地应对趋势，并避免将度量转换为差异。

[图 5.8](图5-8。)

[图 5.9](图5-9。来自原始数据的指数平滑控制图的残差直方图。)

现在，当指标低于下限控制线时，很容易看到吞吐量下降。 至少在视觉上解释起来要容易得多。

多指数平滑稍微复杂一些，但在这个例子中产生了更好的结果。 它的模型中内置了趋势组件，因此您无需执行任何特殊操作来处理带趋势的指标; 可以说，它可以根据它看到的实际数据进行训练。

这是一个权衡。 您可以将数据转换为使用更好的模型，这可能会损害可解释性，或者尝试开发更复杂的模型。

值得注意的是，基于图5-7和图5-9，两种方法似乎都不能产生完美的高斯残差。 这不是一个主要问题。 至少使用指数平滑控制图，我们仍然能够合理地预测和检测我们感兴趣的异常。

请记住，这是一个狭隘的示例，仅在我们的决策树中展示一条路径。 我们从一系列非常具体的要求（具有显着峰值的短时间尺度）开始，这使我们的最终解决方案成为可能，但它并不适用于所有事情。 如果我们想要查看更大的时间尺度，比如完整的数据集，我们必须考虑其他技术。


## 5.5 结论

本章演示了一些相对简单的技术，您可以将这些技术应用于您已经拥有的工具，例如RRDTool，简单脚本和Graphite。 也许是Redis实例或者其他什么，如果你真的想要得到它的想象力。

这里的想法是尽可能少做大惊小怪。 我们不是想成为数据科学家，我们只是想改进Nagios阈值检查。

是什么让这项工作？ 这主要是关于选择正确的战斗，说实话。 吞吐量与您为数据库服务器选择的KPI一样简单。 然后我们将结果可视化并选择了可能有效的最简单的东西。

不用说，你的里程会有所不同。
