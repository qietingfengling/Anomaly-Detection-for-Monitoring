# 第 1 章 介绍

如果有一个系统能够及时对您新的行为和数据模式进行告警，以便在问题发生之前解决问题，或者在问题出现时抓住机会，那会不会很奇妙？ 如果这个系统是完全万无一失的，并且对你每一个重要的变更进行告警，但是它绝不会在不应该响起警报铃时报警，这不是不可思议吗？ 该系统是异常检测的圣杯。 这种系统不存在，也许永远不会存在。 但是，我们不应该让不完美使我们忽视有用的异常检测是可能的事实，并使那些适当应用它的人受益。

异常检测是一组技术和系统，用于在系统及其可观察的信号中查找异常行为或状态。 我们希望阅读本书的人之所以这样做，是因为他们相信异常检测的承诺，但却被围绕该主题的思想领袖圈子中激烈的争论所迷惑。 我们打算本书帮助揭开该主题的神秘面纱，并澄清在构建异常检测机制时必须做出的一些基本选择。 我们希望读者理解为什么某些异常检测方法在某些情况下比其他方法更有效，以及知道为什么更好地解决某些挑战可能已经到了触手可及。

本书无意成为有关该主题的所有信息的综合来源。 这本书将长达1000页，并且不完整。 它也不是一个逐步指导，建立一个适用于所有应用程序的异常检测系统 - 我们非常确定异常检测的“通用解决方案”是不可能的。 我们认为针对特定情况的最佳方法取决于许多因素，尤其是构建更复杂系统的成本/收益分析。 我们希望本书能够通过概述与异常检测不同方法相关的权衡来帮助您在迷宫中进行导航，这将有助于您在路上分叉时做出判断。

经过几年的工作，我们决定写这本书，将异常检测应用于我们自己在监控和相关用例方面的问题。 我们两人都在VividCortex工作，我们在那里从事大规模，专业化的数据库监控。 在VividCortex，我们以多种方式调整了我们的异常检测肌肉。 在过去的几年里，我们已经建造了，并且更重要的是丢弃了数十个异常探测器。 但不仅如此，我们甚至在VividCortex之前就开始在监控系统中进行异常检测。 我们尝试过统计，启发式，机器学习和其他技术。

我们还与我们的同行一起进行监控，DevOps，异常检测以及各种其他学科。 我们已经为许多人，项目和产品以及包括Ruxit在内的公司建立了深刻而持久的尊重。 我们试图通过博客，开源软件，会议演讲以及现在的本书来分享我们的挑战，成功和失败。

## 1.1 为什么要进行异常检测？

监测，观察系统的实践以及确定它们是否健康，很难并且越来越难。 造成这种情况的原因有很多：我们管理的系统（服务器和应用程序或服务）比以往任何时候都多，而且我们正在以更高的分辨率监控它们。 像Etsy这样的公司已经让社区相信，实际上我们可以监控的不仅仅是可能的，而且是可取的，因此我们也会监控来自这些系统的更多信号。

任何这些变化都是一个挑战，但总的来说它们确实是一个非常困难的变化。 因此，现在我们需要挑战这样的场景适合所有指标中。

监控所有这些指标的传统方法无法再充分发挥作用。 有太多的数据需要监控。

我们中的许多人习惯于通过实际观看计算机或墙上的图表或使用Nagios等系统的阈值来进行视觉监控。 阈值实际上代表了监控太难以有效完成的主要原因之一。 简单地说，阈值不能很好地工作。 在度量标准上设置阈值需要系统管理员或DevOps从业者决定要配置的正确值。

问题是，没有正确的价值。 静态阈值就是：静态。 它不会随时间变化，默认情况下会统一应用于所有服务器。 但系统既不相似也不静止。 每个系统都彼此不同，甚至个别系统也会在长期，小时到小时或分钟到分钟之间发生变化。

结果是，阈值设置和维护的工作量太大，导致错误警报和错过警报。 错误警报，因为正常行为被标记为问题，并且错过了警报，因为阈值设置在无法解决问题的级别。

您可能没有意识到这一点，但基于阈值的监控实际上是异常检测的粗略形式。 当度量标准超过阈值并触发警报时，它实际上将度量标准的值标记为异常。 问题的根源在于这种形式的异常检测无法适应系统的独特和变化行为。 它无法学习什么是正常的。

你已经使用了异常检测技术的另一个方法是使用功能，比如Nagios的扑抑制，当检查的结果状态之间振荡，这不允许报警。 这是低通滤波器的粗略形式，是一种丢弃噪声的信号处理技术。 它有效，但不是很好，因为它的噪音概念不是很复杂。

一个常见的假设是更复杂的异常检测可以解决所有这些问题。 我们假设异常检测可以帮助我们减少误报和错过警报。 我们假设它可以帮助我们以更少的工作更准确地发现问题。 我们假设它可以在系统处于不稳定状态时抑制噪声警报。 我们假设它可以自动且零配置地了解系统的正常情况。

我们为什么要假设这些东西？ 他们是合理的假设吗？ 这是本书的目标之一：帮助你理解你的假设，其中一些你可能没有意识到你正在做的。 通过明确的假设，我们相信您将做好更好的决策。 您将能够理解异常检测的功能和局限性，并为手头的任务选择合适的工具。

## 1.2 多种类型的异常检测

异常检测是一个复杂的主题。 你可能已经理解了这一点，但它可能仍然比你想象的更复杂。 有许多种异常检测技术。 每种技术都有令人眼花缭乱的变化。 这些中的每一个都适合或不适合用于许多场景。 它们中的每一个都有许多边缘情况，可能导致不良结果。 其中许多是基于高级数学，统计学或其他学科，这是我们大多数人无法企及的。

尽管如此，在一般情况下，异常检测仍有许多成功案例。 事实上，作为一个专业，我们迟迟未将大规模的异常检测应用于监测。 它当然已经完成，但如果你看其他专业，各种类型的异常检测是标准做法。 这适用于诸如信用卡欺诈检测，恐怖活动监控，金融，天气，赌博以及更多无法提及的领域。 与此相反，在系统监测中，我们通常不将异常检测视为标准实践，而是将其视为具有潜在前景但前沿的东西。

本书的作者大体上同意这一评估。 在将异常检测视为监测工具包的标准部分之前，我们还看到了一些需要克服的障碍：

- 很难开始，因为在你甚至可以开始获得结果之前需要学习很多东西。
- 即使您做了大量工作并且结果看起来很有希望，当您将某些内容部署到生产环境中时，您可能会发现效果不佳，以至于您的工作没有任何用处。
- 通用解决方案在许多领域都是不可能或极难实现的。 这部分是因为机器数据的多样性令人难以置信。 显然还有几乎无数的边缘情况和坑洼可以让你绊倒。 在许多这样的情况下，事情看起来效果很好，即使他们真的没有，或者他们意外地工作得很好，导致你认为它是设计的。 换句话说，确定某些东西是否真的有效是一个非常微妙的事情。
- 在互联网和其他来源中似乎可以无限地提供不完整的信息。 有些甚至可能在本书中。
- 异常检测是一个时髦的话题，它目前非常酷，并且在编写或谈论它时被认为是领导者，似乎有动机对刚刚提到的已经有害的大量信息进行侮辱。
- 许多方法都是基于统计学和概率的，这两种方法都非常不直观，并且通常会产生令人惊讶的结果。 根据作者的经验，与直觉统计相比，很少有事情可以让你误入歧途。

因此，异常检测似乎是一个极端的话题。 有些人尝试，或观察其他人的努力和结果，并得出结论认为这是不可能或困难的。 他们放弃了希望。 这是一个极端。 在另一个极端，有些人找到了好的结果，或者相信他们已经找到了好的结果，至少在某些特定情况下。 他们错误地认为他们已经找到了一个可以在更多场景中使用的通用解决方案，并且他们将它传播得有点过分。 这种过度热情可能导致其他人的消极和诽谤。 因此，我们似乎在圣杯和沮丧之间转向。 每个极端实际上都是过度修正，反馈到循环中。

遗憾的是，这对于教育人们了解异常检测的真实性质和好处并没有多大帮助。 一个结果是很多人错过了他们可能得到的好处。 另一个原因是他们可能没有足够的信息来对商业上可用的异常检测解决方案提出现实意见。 正如Zen Master Hakuin所说，

## 1.3 结论

如果您像DevOps和网络运营社区中的大多数朋友一样，您可能会选择这本书，因为您在过去几年中已经听到了很多关于异常检测的信息，并且您对它很感兴趣。 除了前面提到的明确假设的目标之外，我们希望能够在本书中实现许多成果。

- 我们希望帮助您了解主题和景观。 我们希望您有一个参考框架来考虑异常检测，因此您可以自己做出决定。
- 我们希望帮助您了解如何不仅评估从异常检测算法得到的答案的含义，而且还要了解答案的可信度。
- 我们希望教你一些你可以实际应用于你自己的系统和你自己的问题的东西。 我们不希望这只是一堆理论。 我们希望您付诸实践。
- 我们希望您花在阅读本书上的时间对本书有用。 我们希望您能够将您学到的知识应用到本书未涵盖的主题中。

如果您已经了解异常检测，统计数据或本书中涉及的任何其他内容，您将会看到我们忽略或掩盖了许多重要信息。 这是不可避免的。 从以往的经验来看，我们已经了解到，帮助人们形成有用的思维过程和心理模型比告诉他们要思考什么更好。

因此，我们希望您能够将本书中的材料与您现有的工具和技能相结合，以解决系统中的问题。 总的来说，我们希望你在你已经做的事情上变得更好，并学习一两个新的技巧，而不是解决世界饥饿问题。 如果你问，“我能做些什么比Nagios好一点？”你走在正确的轨道上。

异常检测不是黑白话题。 有很多灰色区域，很多中间地带。 尽管主题的复杂性和丰富性，但它既有趣又富有成效。 尽管存在困难，但在实践中应用它还有很多希望。

介于静态阈值和魔法之间，有一种快乐的媒介。 在本书中，我们努力帮助您找到平衡，同时避免一些尖锐的边缘。




