# 第 3 章 建模和预测

异常检测基于从模型导出的预测。 简单来说，模型是表达您之前关于系统的知识以及您希望它如何工作的一种方式。 模型可以像单个数学方程一样简单。

模型很方便，因为它们为我们提供了一种描述可能复杂的过程或系统的方法。 在某些情况下，模型直接描述管理系统行为的过程。 例如，VividCortex的自适应故障检测算法使用了Litt t's law1，因为我们知道我们监控的系统遵守这个定律。 另一方面，您可能有一个过程，其机制和管理原则不明显，因此没有明确定义的模型。 在这些情况下，您可以尝试尽可能地将模型拟合到观察到的系统行为。

为什么建模如此重要？ 通过异常检测，您有兴趣找到不寻常的东西，但首先您必须知道会发生什么。 这意味着你必须做出预测。 即使它是隐含的和未说明的，这个预测过程也需要一个模型。 然后，您可以将观察到的行为与模型的预测进行比较。

几乎所有在线时间序列异常检测都通过将当前值与基于先前值的预测进行比较来工作。 在线意味着您正在进行异常检测，因为您会看到每个新值出现，并且在线异常检测是本书的主要关注点，因为它是发现系统问题的唯一方法。 在线方法不是即时的 - 可能会有一些延迟 - 但它们可以替代收集大量数据并在事后进行分析，这往往会发现问题太晚。

在线异常检测方法需要两件事：过去的数据和模型。 它们共同构成了预测的基本组成部分。

有许多罐装模型可供使用。 您通常可以在R包中找到它们。 您还可以找到以常用方法隐式编码的模型。 统计过程控制就是一个例子，因为它无处不在，我们接下来会看一下。

## 3.1 控制统计过程

统计过程控制（SPC）基于运营研究，以在工程系统（如制造）中实施质量控制。 在制造过程中，重要的是检查装配线是否达到了所需的质量水平，以便在浪费大量时间和金钱之前纠正问题。

一个指标可能是部件中钻孔的大小。 这个洞永远不会是正确的尺寸，但应该在一个理想的容差范围内。 如果孔超出公差限制，则可能暗示钻头钝或夹具松动。 SPC有助于发现这些问题。

SPC描述了一系列方法背后的框架，每个方法都在复杂程度上进行。 工程统计手册是获取有关过程控制技术的更详细信息的绝佳资源。 我们将按照复杂性的顺序解释一些常见的SPC方法。

### 3.1.1 基本控制图

最基本的SPC方法是一个控制图，表示围绕平均值和控制限制聚集的值。 这也称为休哈特控制图。 固定平均值是我们期望的值（例如，钻头的尺寸），并且控制线与该平均值相比固定了一定数量的标准偏差。 如果你听说过三西格玛规则，这就是它的意义所在。 三个sigmas代表三个标准偏差远离平均值。 围绕均值的两条控制线代表可接受的值范围。

```test
高斯（正态）分布

分布表示每个可能值发生的频率。 直方图通常用于可视化分布。 高斯分布，也称为正态分布或“钟形曲线”，是统计学中常用的分布，在自然界中也是普遍存在的。 许多自然现象，如硬币翻转，人体特征，如高度和天文观测，已被证明至少近似正常分布。 高斯分布具有许多很好的数学性质，很好理解，并且是许多统计方法的基础。
```
[图 3.1]()

基本固定控制图所做的假设之一是价值稳定：价值的均值和价差是恒定的。 作为公式，这组假设可表示为：y =μ+ɛ。 字母μ表示常数均值，ɛ是表示系统中噪声或误差的随机变量。

在基本控制图模型的情况下，假设ɛ是高斯分布随机变量。

控制图具有以下特征：
- 他们假定固定或已知的均值和价值分布。
- 假设这些值是高斯（通常）分布在均值周围。
- 它们可以检测一个或多个超出所需范围的点。

[图 3.2](图3-2。 具有固定控制限制的基本控制图，用虚线表示。 如果超过控制限值，则认为值是异常的。)

### 3.1.2 移动窗口控制图

基本控制图的主要问题是稳定性假设。 在时间序列分析中，通常的术语是静止的，这意味着值具有一致的均值并随时间推移。

许多系统都在快速变化，因此您无法为正在监控的指标假设一个固定的平均值。 如果没有这个关键假设保持为真，你将得到误报或未能检测到真正的异常。 为了解决这个问题，控制图需要适应一个变化的平均值并随着时间的推移而扩展。 有两种基本方法可以做到这一点：

- 将控制图切割成较小的时间范围或固定窗口，并将每个窗口视为具有不同均值和扩展的独立固定控制图。 每个窗口中的值用于计算该窗口的平均值和标准偏差。 在很短的时间间隔内，每件事看起来都像是一个固定的固定控制图。 在更大的范围内，您拥有的是一个在窗口之间变化的控制图。
- 使用移动窗口，也称为滑动窗口。 不是使用预定义的时间范围来构造窗口，而是在每个点生成一个覆盖前N个点的移动窗口。 好处是，不是在一个时间范围内具有固定平均值，而是在每个值之后的平均值变化仍然考虑相同数量的点来计算平均值。

移动窗户有很大的缺点。 您必须跟踪最近的历史记录，因为您需要考虑落入窗口的所有值。 根据窗口的大小，这可能在计算上非常昂贵，尤其是在跟踪大量指标时。 在存在大的尖峰时，Windows也具有较差的特性。 当尖峰进入窗口时，它会导致窗口突然移动，直到尖峰最终离开，这会导致另一次突然移位。

[图 3.3](图3-3。 移动窗口控制图。 与图3-2中所示的固定控制图不同，此移动窗控制图具有自适应控制线和控制限制。 在每次异常尖峰之后，控制限制变宽以形成明显的盒形状。 当异常值落在移动窗口之外时，此效果结束。)

移动窗口控制图具有以下特征：

- 它们要求您保留一定数量的历史数据以计算平均值和控制限制。
- 假设这些值是高斯（通常）分布在均值周围。
- 它们可以检测一个或多个超出所需范围的点。
- 数据中的尖峰可能会导致参数在远处（当它们退出窗口时）发生突然变化。

### 3.1.3 指数加权控制图

指数加权控制图解决了“尖峰出现问题”，其中遥远的历史影响控制线，通过用无限大，逐渐衰减的窗口替换固定长度的移动窗口。 这可以使用指数加权移动平均值来实现。

```text
指数加权移动平均线

指数加权移动平均线（EWMA）是移动窗口计算移动平均线的另一种选择。 EWMA不是使用固定数量的值来计算窗口内的平均值，而是考虑所有先前的点，但对更新的数据赋予更高的权重。 顾名思义，这种权重呈指数衰减。 但是，实现仅使用单个值，因此不必“记住”大量历史数据。

从UNIX负载平均值到股票市场预测和报告，EWMA无处不在，因此您可能已经拥有至少一些经验！ 它们与统计学领域或高斯分布几乎没有关系，但在监视中非常有用，因为它们几乎不使用任何内存或CPU。

EWMA的一个缺点是它们的值是非决定性的，因为它们基本上具有无限的历史。 这可能使他们难以排除故障。

```

EWMA不断腐蚀窗户。 值永远不会“移出”EWMA的尾部，因此当大值变大时，控制图中永远不会出现突然的变化。 但是，由于EWMA的头部立即过渡，当首次观察到较大值时，EWMA控制图仍然会发生突然变化。 这通常不是一个问题，因为虽然平滑值变化很大，但它会响应当前数据而不是非常旧的数据而发生变化。

使用EWMA作为控制图中的平均值很简单，但控制限制线怎么样？ 使用固定长度的窗口，您可以轻松计算窗口内的标准偏差。 使用EWMA，如何做到这一点就不那么明显了。 一种方法是保持值的平方的另一个EWMA，然后使用以下公式计算标准偏差。

StdDev(Y) = sprt(EWMA(Y2) −EWMA(Y2))

[图 3.4](图3-4。 指数加权移动窗口控制图。 这与图3-3类似，不同之处在于当异常值老化时，它不受控制极限宽度的突然变化的影响。)

指数加权控制图具有以下特征：

- 它们具有内存和CPU效率。
- 假设这些值是高斯（通常）分布在均值周围。
- 它们可以检测一个或多个超出所需范围的点。
- 尖峰可以暂时使控制线膨胀，足以导致之后错过警报。
- 它们可能难以调试，因为EWMA的值很难从数据本身确定，因为它基于潜在的“无限”历史。

### 3.1.4 窗口功能

滑动窗口和EWMAs是窗口功能的更大范畴的一部分。 它们是具有两个和一个锐边的窗函数。

有许多窗口函数具有许多不同的形状和特征。 一些函数从0平滑地增加到1并且再次返回，这意味着它们使用过去和未来数据来平滑数据。 双向平滑可以消除大尖峰的影响。

[图 3.5](图3-5。 窗口功能控制图。 这次，窗口由当前值的两侧的值形成。 因此，异常尖峰即使在首次进入窗口时也不会产生控制限制的突然变化。)

窗口函数的缺点是它们需要更大的时间延迟，这是由于在观察到足够的未来值之前不知道平滑值。 这是因为当您将“双向窗口函数”置于“现在”中心时，它将延伸到未来。 在实践中，对于无法测量或等待未来值的情况，EWMA是一个足够好的折衷方案。

基于双向平滑的控制图具有以下特征：

- 它们会在计算中引入时滞。 如果你在60个秒窗口对称平滑，你将不知道“现在”的平滑值，直到30秒 - 窗口的一半 - 已经过去。
- 像滑动窗口一样，它们需要更多的内存和CPU来计算。
- 与我们迄今为止讨论的所有SPC控制图一样，它们假设数据的高斯分布。

## 3.2 更高级的时间序列建模

整个系列的时间序列模型和方法比我们迄今为止所涵盖的更为先进。 特别是，ARIMA系列时间序列模型和周围的方法学被称为Box-Jenkins方法，在本科统计程序中作为统计时间序列的介绍进行了教学。 这些模型表达了更复杂的特征，例如时间序列，其当前值取决于过去某个距离的给定数量的值。 ARIMA模型经过广泛研究，非常灵活，为高级时间序列分析奠定了坚实的基础。 工程统计手册有几个部分涉及ARIMA模型等。 预测：原则和实践是另一种介绍性资源。

您可以对这些模型应用许多扩展和增强，但方法通常保持不变。 我们的想法是拟合或训练模型来抽样数据。 拟合意味着调整参数（系数）以最小化样本数据与模型预测之间的偏差。 然后，您可以使用参数进行预测或得出有用的结论。 由于这些模型和技术非常受欢迎，因此R和其他平台中提供了大量的软件包和代码资源。

ARIMA系列模型具有许多“开/关切换”，其包括或排除模型的特定部分，如果启用，则可以调整每个部分。 因此，它们极其模块化和灵活，可以从简单到非常复杂。

一般来说，有很多模型，通过一些工作，你可以经常找到一个非常适合你的数据（因此具有很高的预测能力）。 但是研究和理解Box-Jenkins方法的真正价值在于方法本身，它在所有模型中保持一致，并提供了推理时间序列分析的合理方法。

```text
参数和非参数统计和方法

也许您已经听说过参数化方法。 这些是具有必须通过拟合指定或选择的系数的统计方法或工具。 到目前为止我们提到的大多数事情都有参数。 例如，EWMA具有衰减参数，您可以调整该参数以将值偏向更近期或更多历史数据。 均值的值也是一个参数。 ARIMA模型充满了参数。 常用的统计工具，例如高斯分布，具有参数（平均值和扩散值）。

非参数方法独立于这些参数工作。 您可能会认为它们在无量纲数量上运行。 这使它们在某些方面更加强大，但也可以降低它们的描述能力。
```

## 3.3 预测时间序列数据

虽然我们还没有谈到预测，但到目前为止我们讨论过的所有工具都是为预测而设计的。 预测是异常检测的基础之一。 评估任何度量标准的值必须通过将其与“应该是什么”进行比较来完成，这是一种预测。

对于异常检测，我们通常有兴趣预测前一步，然后将此预测与我们看到的下一个值进行比较。 与SPC和控制图一样，有一系列预测方法，复杂性增加：

- 最简单的一步预测是预测它将与最后一个值相同。 这类似于天气预报。 最简单的天气预报明天就像今天一样。 令人惊讶的是，做出主观上比预测更好的预测是一个难题！ 唉，这个简单的方法，“下一个值将与当前值相同”，如果系统随时间不稳定（静止），则效果不佳。
- 下一个复杂程度是预测下一个值将与最近的集中趋势相同。 集中趋势一词指的是汇总统计：单个值试图尽可能描述数据集合。 使用汇总统计数据，您的预测公式将变为类似“下一个值将与最近值的当前平均值相同。”现在您预测值最有可能接近最近通常的值。 您可以将“平均值”替换为中位数，EWMA或其他描述性摘要统计信息。
- 超出此范围的一步是预测围绕汇总统计数据的可能值范围。 这通常归结为扩散的中心值和标准偏差的简单均值，或具有EWMA控制限制的EWMA（类似于平均值和标准偏差，但是指数平滑）。
- 所有这些方法都使用参数（例如，平均值和标准偏差）。 也可以使用非参数方法，例如历史值的直方图。 我们将在本书后面更详细地讨论这些内容。

我们可以使用更复杂的模型（例如ARIMA家族的模型）将预测提升到更高的复杂程度。 此外，您还可以尝试基于指标组合构建自己的模型，并使用相应的输出输入控制图。 我们还将在本书后面讨论。

预测通常是一个难题，但在处理机器数据时尤其困难。 机器数据有多种形状和大小，期望单一方法或方法适用于所有情况是不合理的。

根据我们的经验，大多数异常检测成功案例都有效，因为他们使用的具体数据并未达到病态。 大量机器数据具有简单的病理，可以快速打破许多模型。 这使得准确，强大的预测比您想象的更难。

## 3.4 评估预测

异常检测中最重要和最微妙的部分之一发生在预测度量应该如何表现的交叉点上，以及将观察值与这些期望进行比较。

在异常检测中，你通常会使用许多标准偏差作为非常不可能的替代，当你远离平均值时，你就处于分布的尾部。这里的拟合往往比你期望的要糟糕得多，所以即使是高斯的小偏差也可能导致比你理论上更多的异常值。

同样，许多统计测试如假设测试被认为是“重要的”或“好的”，这基于结果是统计学家的经验法则。 仅仅因为某些p值看起来非常好并不意味着确实有很多确定性。 “重大”可能并不意味着什么。 嘿，这毕竟是统计数据！

因此，您的异常检测技术很可能有时会给您带来比您认为的更多的误报。这些问题总会发生;这只是课程的标准。我们将在后面的章节中讨论一些缓解这种情况的方法。

## 3.5 关于统计异常检测的常见误区

我们通常听到声称某些技术（例如SPC）不起作用，因为系统指标不是高斯的。 断言是唯一可行的方法是复杂的非参数方法。 这是对统计数据混淆的过度简化。

这是一个例子。 假设您捕获了一些“神秘时间序列”的观察结果。我们在图3-6中绘制了这一点。

[图 3.6](图3-6。 一个神秘的时间序列，我们假装什么都不知道。)

你的时间序列是高斯分布的吗？ 您决定检查，以便启动R环境并绘制时间序列数据的直方图。 为了进行比较，您还可以使用与样本数据相同的均值和标准差覆盖正态分布曲线。 结果如图3-7所示。

[图 3.7](图3-7。 神秘时间序列的直方图，覆盖正态分布“钟形曲线”。)

嗯，哦！ 它看起来不太合适。 你应该放弃希望吗？ 不，你偶然发现了统计流沙：

- 数据是高斯数据并不重要。 重要的是残差是否是高斯分布。
- 直方图是数据样本，但是人口而不是样本是重要的。

让我们探讨这些主题。

### 3.5.1 数据不需要是高斯数据

残差而不是数据需要是高斯（正态）才能使用三西格玛规则等。

什么是残差？ 残差是预测中的错误。 它们是模型预测与实际观察值之间的差异。

如果你衡量一个系统的行为是对数正态分布，并立足于它的预测是对数正态分布模型的预测，并在预测误差是正态分布的，标准的SPC使用三西格玛置信区间控制结果的图表可以工作得很好。

同样，如果您有多模态数据（其分布看起来像骆驼的驼峰），并且您的模型的预测会导致正态分布的残差，那么您做得很好。

事实上，您的数据可能看起来有点疯狂。 没关系; 重要的是残差是否为高斯分布。 理解这一点非常重要。 我们之前讨论的每种控制图实际上都是这样的：

- 它以某种方式对度量标准的行为进行建模。 例如，EWMA控制图的隐含模型是“下一个值可能接近EWMA的当前值”。
- 它从观察值中减去预测。
- 它有效地将控制线放在残差上。 这个想法是残差现在是一个稳定的值，以零为中心。

任何控制图都可以实现：

- 预测，取残差，找出控制极限，评估残差是否超出界限
- 预测，围绕预测值扩展控制线，评估值是否在边界内

这是同一件事。 这只是以不同的顺序进行数学运算的问题，并且操作是可交换的，因此您可以获得相同的答案。

使用控制图的整个想法是找到一个模型，它可以很好地预测你的数据，残差是高斯的，所以你可以使用三西格玛或类似的技术。 这是一个有用的框架，如果你可以使它工作，你的很多工作已经完成。

有时人们会认为任何旧模型都会自动保证高斯残差。 它没有; 你需要找到合适的模型，并检查结果以确定。 但即使残差不是高斯分布，事实上，很多模型可以很好地预测数据，残差很小，所以你仍然可以得到很好的结果。

### 3.5.2 样本分布与人口分布

我们说明的第二个错误是不了解样本和人口统计之间的差异。 当您使用统计数据时，您需要知道您是在评估您拥有的数据样本的特征，还是尝试使用该示例来推断有关较大数据量（您没有的数据）的信息。 顺便说一句，通常是后者。

当我们绘制样本的直方图并说它看起来不是高斯时，我们犯了一个错误。 该样本将具有随机性，并且与绘制它的完整人口看起来不完全相同。 “样本高斯”是不是要问的正确问题。 正确的问题是，松散地说，“这个样本来自高斯人口的可能性有多大？”这是一个标准的统计问题，所以我们不会在这里展示如何找到答案。 最重要的是要意识到差异。

几乎所有的统计工具都有基于样本的技术来尝试推断人口的特征。

顺便说一句，有一个谣言说，无论人口的分布是什么，中心极限定理都能保证任何人口的样本都能正常分布。 这是对该定理的误读，我们向您保证机器数据不是自动高斯的，因为它是通过采样获得的！

## 3.6 结论

所有异常检测都依赖于预测度量的预期值或值范围，然后将观察结果与预测进行比较。 预测依赖于模型，模型可以基于理论或经验证据。 模型通常使用历史数据作为输入来导出用于预测未来的参数。

我们讨论了SPC技术，不仅因为它们无处不在，而且在与良好的模型（我们将重新审视的主题）配对时非常有用，但是因为它们体现了一个对于处理各种异常检测非常有用的思维过程 问题。 这个思维过程可以应用于许多不同类型的模型，包括ARIMA模型。

在对某些数据进行建模和预测以尝试检测其中的异常时，需要评估结果的质量。 这实际上意味着您需要测量预测误差 - 剩余 - 并评估模型在预测系统数据方面的优势。 如果您将使用SPC来确定哪些观测结果是异常的，则通常需要确保残差是正态分布的（高斯分布）。 执行此操作时，请确保不要将样本分布与人口分布混淆！